<!DOCTYPE html><html><head><meta charset="utf-8" /><meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" /><title>Proud Blog - 「AWS WAF」を導入してみた。- SQL injection編</title><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><link href="/stylesheets/all.css" rel="stylesheet" /></head><body><header><h1><a href="/">Proud Blog</a></h1><ul class="header-social"><li><a href="https://www.facebook.com/proudit/"><i class="fa fa-facebook-square fa-2x"></i></a></li><li><a href="https://github.com/proudit"><i class="fa fa-github fa-2x"></i></a></li></ul></header><div id="main" role="main"><article><h1>「AWS WAF」を導入してみた。- SQL injection編</h1><div class="tag-labels"><small class="tag-label">AWS</small><small class="tag-label">WAF</small><small class="tag-label">CloudFront</small></div><br /><p><img class="author" src="/images/authors/kohei.png" /> <i class="fa fa-pencil"></i>Written by    <b>Kohei Yamada</b>　<i class="fa fa-clock-o"></i>Posted on  <b>2016/01/07</b></p><p><div style="width:74px;height:22px;float:left;"><div style="margin-left:-5px"><a href="https://twitter.com/share" class="twitter-share-button"{count} data-via="proudit_inc" data-lang="ja" data-hashtags="proudblog" data-dnt="true">ツイート</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></div></div><div style="width:120px;height:22px;float:left;"><iframe src="//www.facebook.com/v2.0/plugins/like.php?href=http%3A%2F%2Fblog.proudit.jp&amp;width&amp;layout=button&amp;action=like&amp;show_faces=false&amp;share=true&amp;height=90&amp;appId=1679223382318515" scrolling="no" frameborder="0" style="border:none; overflow:hidden; height:90px;" allowTransparency="true"></iframe></div></p><hr /><br /><h1 id="はじめに">はじめに</h1>

<hr>

<p>2015年のre:Inventで「AWS WAF」が発表されました。</p>

<p>AWS WAFはアプリケーション用のファイアウォールで、IP address、SQL injection、String matchingに関するアクセスの制御ができます。<br>
ただ、このサービスを利用するにはCloudFront経由でのアクセスにしか対応していないため、ELBやEC2にWAFを導入する場合はCloudFrontを配置する必要があります。</p>

<p>今回は既に作成済みの「waf-test-acl」にSQL injectionの設定を追加してみます。<br>
その他の設定については以下参照ください。<br>
<a href="../../../2015/12/28/aws-waf-ipaddress.html">「AWS WAF」を導入してみた。- IP addresses編</a><br>
<a href="../../../2016/01/12/aws-waf-stringmatching.html">「AWS WAF」を導入してみた。- String matching編</a></p>

<h1 id="1.設定">1.設定</h1>

<hr>

<h2 id="①-conditionの作成">① Conditionの作成</h2>

<p>まず、SQL injectionをクリックします。<br>
<img alt="aws-waf_sql-injection_2015120401.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/3c0e488c-ab1e-ed97-73ef-5f8b66a183ef.png" /></p>

<p>「Create condition」をクリックします。<br>
<img alt="aws-waf_sql-injection_2015120402.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/a8744128-6c9f-e323-dc85-8ca16f70d176.png" /></p>

<p>「Name」には任意のコンディション名を入力します。<br>
また、Filter settingsの「Part of the request to filter on」でチェックしたいWeb要求、「Transformation」でAWS WAFがリクエストをチェックする前に行う変換方式を指定し、OKであれば「Add another filter」をクリックして条件に追加します。<br>
<img alt="aws-waf_sql-injection_2015120403.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/31948ec2-c58c-a4d7-0b26-19504d9f84dd.png" /></p>

<p>Filters in this SQL injection match conditionへの追加が確認できたら「Create」をクリックして作成します。<br>
<img alt="aws-waf_sql-injection_2015120404.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/54e80d2d-720f-349a-96a5-04f6a25697ca.png" /></p>

<p><br></p>

<h2 id="②-ruleの作成">② Ruleの作成</h2>

<p>conditionを作成したら、次に「Rules」をクリックします。<br>
<img alt="aws-waf_sql-injection_2015120405.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/e91e32cb-55dd-1018-0b0a-838d546e070c.png" /></p>

<p>Rules設定画面が表示されたら「Create rule」をクリックしルールの作成を行います。<br>
<img alt="aws-waf_sql-injection_2015120406.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/2c386f4c-78bb-07ae-377c-dd1112e035f6.png" /></p>

<p>先ほどConditionsのSQL injectionで作成したルールを設定し、完了したら「Create」をクリックします。<br>
<img alt="aws-waf_sql-injection_2015120407.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/4e5abd0b-ec03-3f5b-8b8c-72fc924cb72e.png" /></p>

<p>ルールの作成が完了したら「Web ACLs」をクリックします。<br>
<img alt="aws-waf_sql-injection_2015120408.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/f8f07011-cc24-5d48-9b06-b47db0383cee.png" /></p>

<p><br></p>

<h2 id="③-access-control-listへの追加">③ Access Control Listへの追加</h2>

<p>今回ルールを追加する対象のACL名をクリックします。<br>
<img alt="aws-waf_sql-injection_2015120409.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/8340e1bf-1517-1eac-f827-0d4435bbedb5.png" /></p>

<p>タブ「Rules」をクリックして「Edit web ACL」をクリックします。<br>
<img alt="aws-waf_sql-injection_2015120410-1.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/a4139ba3-e738-78b4-3ac2-3fca43ebe0a1.png" /></p>

<p>「Rules」のプルダウンで今回作成したルールを選択し、「Add rule to web ACL」をクリックすると下の”If a request matches all the conditions in a rule, take the corresponding action”に追加されます。そうしたら今回はブロックをしたいため「Block」にチェックし、「Update」をクリックします。<br>
<img alt="aws-waf_sql-injection_2015120411.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/32de316d-d008-4001-a91c-527d05e48b79.png" /></p>

<p>ルールが追加されました。「Requests」タブをクリックするとリクエストログが確認できます。<br>
<img alt="aws-waf_sql-injection_2015120412-1.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/14c360d3-19cc-0783-51aa-c583b61cc2f6.png" /></p>

<p><br>  </p>

<h1 id="2.動作確認">2.動作確認</h1>

<hr>

<h2 id="①-現状確認">① 現状確認</h2>

<p>まずは現状を確認します。リクエストがない状態です。<br>
<img alt="aws-waf_sql-injection_2015120414.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/4fa2ba96-395b-c49d-6a48-694f3e98cbcc.png" /></p>

<p><br></p>

<h2 id="②-ツールの実行">② ツールの実行</h2>

<p>次にsqlmapを実行します。<br>
<img alt="aws-waf_sql-injection_2015120419-1.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/2edf7173-9eef-ea55-316f-d33268c8ff1e.png" /></p>

<p><br></p>

<h2 id="③-リクエスト確認">③ リクエスト確認</h2>

<p>それでは再度、リクエストを確認してみます。<br>
<img alt="aws-waf_sql-injection_2015120415-1.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/3e5b73ce-86ff-f935-760e-1f1a4f8f48ed.png" /></p>

<p>先ほど設定したルール&quot;sql-injection-rule&quot;によってリクエストが「Block」されているのが確認できます。<br>
さらに今回はUser-Agentに対して設定したので、Request headersのUser-Agentを確認するとどういったリクエストを防いだかがわかります。<br>
<img alt="aws-waf_sql-injection_2015120416-1.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/9c7297be-2382-0036-f87a-96050f749dfe.png" /></p>

<p><img alt="aws-waf_sql-injection_2015120417-1.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/68bfd374-a6d0-6bfc-930b-9fbcb01c201a.png" /></p>

<p><img alt="aws-waf_sql-injection_2015120418-1.png" src="https://qiita-image-store.s3.amazonaws.com/0/82090/14cd9731-1cd5-6e62-a8cf-17551086c621.png" /></p>

<p>以上で設定完了です。</p>
<br /><br><div style="width:74px;height:22px;float:left;"><div style="margin-left:-5px"><a href="https://twitter.com/share" class="twitter-share-button"{count} data-via="proudit_inc" data-lang="ja" data-hashtags="proudblog" data-dnt="true">ツイート</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></div></div><div style="width:120px;height:22px;float:left;"><iframe src="//www.facebook.com/v2.0/plugins/like.php?href=http%3A%2F%2Fblog.proudit.jp&amp;width&amp;layout=button&amp;action=like&amp;show_faces=false&amp;share=true&amp;height=90&amp;appId=1679223382318515" scrolling="no" frameborder="0" style="border:none; overflow:hidden; height:90px;" allowTransparency="true"></iframe></div></br><br /><br /></article><aside><fieldset><h2>最近の投稿</h2><ol><li> <i class="fa fa-caret-right"><a href="/2016/06/06/assign-your-own-domain-to-the-aws-s3-bucket.html">AWS S3バケットに独自ドメインを割り当てる。</a></i></li><li> <i class="fa fa-caret-right"><a href="/2016/05/30/how-to-install-the-idcf-command-line-tool-for-macosx.html">IDCFクラウドのコマンドラインツールをインストールする。 - MacOSX</a></i></li><li> <i class="fa fa-caret-right"><a href="/2016/05/27/jQuery-validation-1.html">jQuery Validationを使ってフォームチェックをしてみる</a></i></li><li> <i class="fa fa-caret-right"><a href="/2016/05/26/how-the-vpn-connection-to-AWS-and-IDCF-4.html">第４回 AWSとIDCFをVPN接続する - 最後の仕上げ編</a></i></li><li> <i class="fa fa-caret-right"><a href="/2016/05/18/screendhot-file.html">スクロールが必要なweb画面のスクリーンショットを撮る方法</a></i></li><li> <i class="fa fa-caret-right"><a href="/2016/05/16/how-the-vpn-connection-to-AWS-and-IDCF-3.html">第３回 AWSとIDCFをVPN接続する - VPN接続編（全４回）</a></i></li><li> <i class="fa fa-caret-right"><a href="/2016/05/11/long-Holiday.html">2016年ゴールデンウィーク！</a></i></li><li> <i class="fa fa-caret-right"><a href="/2016/05/09/how-the-vpn-connection-to-AWS-and-IDCF-2.html">第２回 AWSとIDCFをVPN接続する - AWS準備編（全４回）</a></i></li><li> <i class="fa fa-caret-right"><a href="/2016/05/02/how-the-vpn-connection-to-AWS-and-IDCF-1.html">第１回 AWSとIDCFをVPN接続する - IDCF準備編（全４回）</a></i></li><li> <i class="fa fa-caret-right"><a href="/2016/04/28/What's-DevOps.html">DevOpsってなんだろう？</a></i></li></ol></fieldset><fieldset><h2>投稿者</h2><ol><li> <i class="fa fa-pencil"><a href="/toguma.html">toguma</a></i></li><li> <i class="fa fa-pencil"><a href="/kohei.html">kohei</a></i></li><li> <i class="fa fa-pencil"><a href="/proudcloud.html">proudcloud</a></i></li><li> <i class="fa fa-pencil"><a href="/ayako.html">ayako</a></i></li></ol></fieldset><fieldset><h2>タグ</h2><ol><li> <i class="fa fa-tag"><a href="/tags/aws.html">AWS (14)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/github.html">GitHub (5)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/circleci.html">CircleCI (4)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/s3.html">S3 (4)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/lambda.html">lambda (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/cognito.html">cognito (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/waf.html">WAF (3)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/cloudfront.html">CloudFront (4)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/redmine.html">Redmine (2)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/amazonlinux.html">AmazonLinux (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/ec2.html">EC2 (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/mocloud.html">moCloud (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/hubot.html">Hubot (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/slack.html">Slack (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/jawsdays2016.html">jawsdays2016 (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/linux.html">Linux (3)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/vnstat.html">vnstat (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/vnstati.html">vnstati (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/お知らせ.html">お知らせ (5)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/jawsdays.html">JAWSDAYS (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/aws-cli.html">aws-cli (2)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/macos.html">MacOS (2)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/docker.html">docker (2)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/dockerhub.html">DockerHub (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/sts.html">STS (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/お役立ち情報.html">お役立ち情報 (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/子育.html">子育 (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/日常.html">日常 (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/サーバレス.html">サーバレス (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/非エンジニアから見たインフラの世界.html">非エンジニアから見たインフラの世界 (3)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/s3cmd.html">s3cmd (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/idcf.html">IDCF (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/openssl.html">OpenSSL (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/devops.html">DevOps (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/idcfクラウド.html">IDCFクラウド (6)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/vpn.html">VPN (4)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/vyos.html">VyOS (4)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/vpc.html">vpc (4)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/holiday.html">holiday (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/スクリーンショット.html">スクリーンショット (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/スクロール.html">スクロール (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/chrome拡張機能.html">chrome拡張機能 (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/jquery.html">jQuery (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/validation.html">Validation (1)</a></i></li><li> <i class="fa fa-tag"><a href="/tags/route53.html">route53 (1)</a></i></li></ol></fieldset><fieldset><h2>アーカイブ</h2><ol><li> <i class="fa fa-calendar"><a href="/2016.html">2016 (35)</a></i></li><li> <i class="fa fa-calendar"><a href="/2015.html">2015 (3)</a></i></li></ol></fieldset></aside></div><footer><p><i class="fa fa-copyright"></i> <a href="/">Proud Blog</a> - Powerd by <a href="http://www.proudit.jp/">Proudit Inc.</a></p></footer></body></html>